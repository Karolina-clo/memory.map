<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞—Ä—Ç—ã –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–π</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Arial, sans-serif;
        }
        
        body {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e2e8f0;
            overflow: hidden;
        }
        
        header {
            background: rgba(15, 23, 42, 0.95);
            color: white;
            padding: 12px 20px;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        h1 {
            font-size: 1.6rem;
            background: linear-gradient(90deg, #60a5fa, #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        h1:hover {
            transform: scale(1.05);
            text-shadow: 0 0 15px rgba(96, 165, 250, 0.5);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            color: #94a3b8;
            background: rgba(255, 255, 255, 0.05);
            padding: 5px 10px;
            border-radius: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .header-right {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .stats {
            display: flex;
            gap: 15px;
            font-size: 0.8rem;
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: rgba(255, 255, 255, 0.05);
            padding: 5px 10px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .stat-value {
            font-weight: bold;
            color: #60a5fa;
            font-size: 1rem;
        }
        
        .auth-buttons {
            display: flex;
            gap: 10px;
        }
        
        .auth-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .auth-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        
        .auth-btn.primary {
            background: linear-gradient(90deg, #3b82f6, #1d4ed8);
        }
        
        .auth-btn.primary:hover {
            background: linear-gradient(90deg, #60a5fa, #3b82f6);
        }
        
        .logout-btn {
            background: rgba(239, 68, 68, 0.15);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.3);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .logout-btn:hover {
            background: rgba(239, 68, 68, 0.25);
            transform: translateY(-2px);
        }
        
        .back-to-my-map {
            background: rgba(34, 197, 94, 0.15);
            color: #4ade80;
            border: 1px solid rgba(34, 197, 94, 0.3);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .back-to-my-map:hover {
            background: rgba(34, 197, 94, 0.25);
            transform: translateY(-2px);
        }
        
        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        #map {
            flex: 1;
            height: calc(100vh - 100px);
            z-index: 1;
            background: #0f172a;
        }
        
        .sidebar {
            width: 380px;
            background: rgba(30, 41, 59, 0.95);
            padding: 18px;
            overflow-y: auto;
            border-left: 1px solid rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            z-index: 2;
            transition: transform 0.3s ease;
        }
        
        .sidebar.collapsed {
            transform: translateX(100%);
        }
        
        .toggle-sidebar {
            position: absolute;
            top: 60px;
            right: 390px;
            background: rgba(59, 130, 246, 0.7);
            color: white;
            border: none;
            border-radius: 6px;
            width: 32px;
            height: 32px;
            font-size: 16px;
            cursor: pointer;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .sidebar.collapsed + .toggle-sidebar {
            right: 10px;
        }
        
        .toggle-sidebar:hover {
            background: rgba(96, 165, 250, 0.9);
            transform: scale(1.1);
        }
        
        .view-only-message {
            background: rgba(96, 165, 250, 0.15);
            border: 1px solid rgba(96, 165, 250, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            text-align: center;
            font-size: 0.9rem;
            color: #93c5fd;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .view-only-message i {
            color: #60a5fa;
        }
        
        .view-only-message button {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
        }
        
        .view-only-message button:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        h2 {
            color: #60a5fa;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(96, 165, 250, 0.3);
            font-size: 1.2rem;
        }
        
        h3 {
            color: #94a3b8;
            margin-bottom: 10px;
            font-size: 1rem;
        }
        
        .tab-buttons {
            display: flex;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 4px;
            margin-bottom: 20px;
        }
        
        .tab-btn {
            flex: 1;
            padding: 8px;
            background: transparent;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s;
            font-size: 0.9rem;
        }
        
        .tab-btn.active {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .city-info {
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.03);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .selected-city {
            font-size: 1.3rem;
            color: white;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .delete-city-btn {
            background: rgba(239, 68, 68, 0.15);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.3s;
        }
        
        .delete-city-btn:hover {
            background: rgba(239, 68, 68, 0.3);
        }
        
        .country-name {
            color: #94a3b8;
            font-style: italic;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        
        .coords-display {
            display: flex;
            gap: 12px;
            margin-top: 8px;
        }
        
        .coord-item {
            flex: 1;
            text-align: center;
            background: rgba(255, 255, 255, 0.03);
            padding: 6px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .coord-value {
            font-weight: bold;
            color: #60a5fa;
            font-size: 1rem;
        }
        
        .add-city-form, .photo-form {
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.03);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .form-group {
            margin-bottom: 12px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #94a3b8;
            font-size: 0.85rem;
        }
        
        input[type="text"], textarea, select {
            width: 100%;
            padding: 9px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            font-size: 0.9rem;
            color: #e2e8f0;
            transition: all 0.3s;
        }
        
        input[type="text"]:focus, textarea:focus, select:focus {
            border-color: #60a5fa;
            outline: none;
            box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.2);
            background: rgba(255, 255, 255, 0.08);
        }
        
        textarea {
            height: 70px;
            resize: vertical;
            font-family: inherit;
        }
        
        .loading {
            color: #60a5fa;
            font-style: italic;
            margin-top: 5px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .photo-preview {
            width: 100%;
            max-height: 160px;
            object-fit: cover;
            border-radius: 6px;
            margin-bottom: 10px;
            display: none;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .upload-btn {
            display: inline-block;
            background: rgba(59, 130, 246, 0.15);
            padding: 9px;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 10px;
            text-align: center;
            border: 1px dashed rgba(96, 165, 250, 0.4);
            transition: all 0.3s;
            color: #93c5fd;
            font-size: 0.9rem;
        }
        
        .upload-btn:hover {
            background: rgba(59, 130, 246, 0.25);
            border-color: #60a5fa;
        }
        
        .btn {
            background: linear-gradient(90deg, #3b82f6, #1d4ed8);
            color: white;
            border: none;
            padding: 10px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            width: 100%;
            transition: all 0.3s;
            margin-top: 5px;
        }
        
        .btn:hover {
            background: linear-gradient(90deg, #60a5fa, #3b82f6);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.07);
            margin-top: 0;
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.12);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }
        
        .photo-gallery {
            margin-top: 15px;
        }
        
        .photo-item {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            position: relative;
            transition: all 0.3s;
        }
        
        .photo-item:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(96, 165, 250, 0.2);
        }
        
        .delete-photo-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(239, 68, 68, 0.15);
            color: #f87171;
            border: none;
            border-radius: 4px;
            width: 22px;
            height: 22px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.3s;
        }
        
        .delete-photo-btn:hover {
            background: rgba(239, 68, 68, 0.3);
        }
        
        .photo-item img {
            width: 100%;
            border-radius: 6px;
            margin-bottom: 8px;
            max-height: 160px;
            object-fit: cover;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .photo-caption {
            color: white;
            font-size: 0.95rem;
            margin-bottom: 4px;
            font-weight: 600;
        }
        
        .photo-description {
            color: #94a3b8;
            line-height: 1.4;
            font-size: 0.85rem;
        }
        
        .photo-date {
            color: #64748b;
            font-size: 0.75rem;
            margin-top: 5px;
            display: block;
        }
        
        .empty-gallery {
            text-align: center;
            color: #64748b;
            font-style: italic;
            padding: 20px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        .city-list {
            margin-top: 15px;
            max-height: 180px;
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 6px;
            padding: 8px;
        }
        
        .city-item {
            padding: 8px;
            margin-bottom: 5px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .city-item:hover {
            background: rgba(59, 130, 246, 0.15);
            border-left-color: #60a5fa;
        }
        
        .city-item.active {
            background: rgba(59, 130, 246, 0.25);
            border-left-color: #3b82f6;
        }
        
        .city-name {
            font-weight: 600;
            color: white;
            font-size: 0.95rem;
        }
        
        .city-coords {
            font-size: 0.75rem;
            color: #94a3b8;
        }
        
        .city-actions {
            display: flex;
            gap: 4px;
        }
        
        .city-action-btn {
            background: rgba(255, 255, 255, 0.08);
            border: none;
            border-radius: 3px;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 11px;
            color: white;
            transition: all 0.3s;
        }
        
        .city-action-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .city-action-btn.delete {
            background: rgba(239, 68, 68, 0.15);
            color: #f87171;
        }
        
        .city-action-btn.delete:hover {
            background: rgba(239, 68, 68, 0.3);
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π */
        .users-list {
            margin-top: 15px;
            max-height: 250px;
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 6px;
            padding: 8px;
        }
        
        .user-item {
            padding: 10px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s;
        }
        
        .user-item:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(96, 165, 250, 0.2);
        }
        
        .user-item.active {
            background: rgba(59, 130, 246, 0.15);
            border-color: rgba(59, 130, 246, 0.3);
        }
        
        .user-avatar-small {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.8rem;
        }
        
        .user-details {
            flex: 1;
            margin-left: 10px;
        }
        
        .user-name {
            font-weight: 600;
            color: white;
            font-size: 0.9rem;
        }
        
        .user-stats {
            font-size: 0.75rem;
            color: #94a3b8;
        }
        
        .user-actions {
            display: flex;
            gap: 5px;
        }
        
        .share-btn {
            background: rgba(34, 197, 94, 0.15);
            color: #4ade80;
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.3s;
        }
        
        .share-btn:hover {
            background: rgba(34, 197, 94, 0.25);
        }
        
        .delete-user-btn {
            background: rgba(239, 68, 68, 0.15);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.3s;
        }
        
        .delete-user-btn:hover {
            background: rgba(239, 68, 68, 0.25);
        }
        
        .share-link-container {
            margin-top: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .share-link {
            word-break: break-all;
            font-size: 0.8rem;
            color: #60a5fa;
            margin-bottom: 10px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 4px;
        }
        
        footer {
            text-align: center;
            padding: 8px;
            background: rgba(15, 23, 42, 0.8);
            color: #64748b;
            font-size: 0.75rem;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –≥–ª–æ–±—É—Å–∞ */
        .leaflet-control-container .leaflet-control-attribution {
            display: none !important;
        }
        
        .leaflet-control-zoom {
            margin-top: 60px !important;
            border: none !important;
            background: rgba(0, 0, 0, 0.4) !important;
            backdrop-filter: blur(5px);
        }
        
        .leaflet-control-zoom a {
            background: rgba(59, 130, 246, 0.6) !important;
            color: white !important;
            border: none !important;
            transition: all 0.3s;
        }
        
        .leaflet-control-zoom a:hover {
            background: rgba(96, 165, 250, 0.8) !important;
        }
        
        /* –£–±–∏—Ä–∞–µ–º —Å–∏–Ω–µ–µ –æ–∫–æ—à–∫–æ –ø–æ—Å–ª–µ —Å–∫—Ä—ã—Ç–∏—è */
        .leaflet-popup {
            display: none !important;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –º–∞—Ä–∫–µ—Ä–æ–≤ –≥–æ—Ä–æ–¥–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π */
        .city-marker-icon {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.7);
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 9px;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∏–∫–æ–Ω–æ–∫ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π */
        .mini-photo-marker {
            border: 2px solid white;
            border-radius: 50%;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
            overflow: hidden;
            transition: all 0.3s;
        }
        
        .mini-photo-marker:hover {
            transform: scale(1.2);
            z-index: 1000;
            box-shadow: 0 0 20px rgba(96, 165, 250, 0.8);
        }
        
        .mini-photo-marker img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –º–∞—Ä–∫–µ—Ä–∞ */
        .temp-marker {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.7);
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ */
        .spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(96, 165, 250, 0.3);
            border-radius: 50%;
            border-top-color: #60a5fa;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(10px);
        }
        
        .modal {
            background: linear-gradient(135deg, #1e293b, #0f172a);
            border-radius: 16px;
            padding: 30px;
            width: 90%;
            max-width: 420px;
            border: 1px solid rgba(96, 165, 250, 0.3);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5), 0 0 30px rgba(59, 130, 246, 0.3);
            position: relative;
            animation: modalAppear 0.3s ease-out;
        }
        
        @keyframes modalAppear {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal h3 {
            color: #60a5fa;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.8rem;
            text-shadow: 0 0 10px rgba(96, 165, 250, 0.3);
        }
        
        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #94a3b8;
            font-size: 1.2rem;
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .close-modal:hover {
            background: rgba(255, 255, 255, 0.2);
            color: #f87171;
            transform: rotate(90deg);
        }
        
        .modal .form-group {
            margin-bottom: 20px;
        }
        
        .modal input[type="text"],
        .modal input[type="password"] {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(96, 165, 250, 0.2);
            border-radius: 8px;
            padding: 12px 15px;
            color: white;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .modal input[type="text"]:focus,
        .modal input[type="password"]:focus {
            border-color: #60a5fa;
            box-shadow: 0 0 15px rgba(96, 165, 250, 0.3);
            background: rgba(255, 255, 255, 0.12);
        }
        
        .modal label {
            color: #94a3b8;
            font-size: 0.9rem;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .modal label i {
            color: #60a5fa;
        }
        
        .modal .btn {
            margin-top: 20px;
            padding: 12px;
            font-size: 1rem;
            border-radius: 8px;
        }
        
        .modal-footer {
            margin-top: 20px;
            text-align: center;
            color: #94a3b8;
            font-size: 0.9rem;
        }
        
        .modal-footer a {
            color: #60a5fa;
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
        }
        
        .modal-footer a:hover {
            text-decoration: underline;
        }
        
        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 1024px) {
            .sidebar {
                width: 340px;
            }
            .toggle-sidebar {
                right: 350px;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            #map {
                height: 60vh;
            }
            
            .sidebar {
                width: 100%;
                height: 40vh;
            }
            
            .toggle-sidebar {
                display: none;
            }
            
            .stats {
                display: none;
            }
            
            .auth-buttons {
                flex-direction: column;
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-left">
            <h1 onclick="window.location.reload()" title="–ù–∞ –≥–ª–∞–≤–Ω—É—é">üåç –ö–∞—Ä—Ç—ã –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–π</h1>
            <div class="user-info" id="userInfo" style="display: none;">
                <div class="user-avatar" id="userAvatar">U</div>
                <div>
                    <div id="userName">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
                    <div id="userStats" style="font-size: 0.75rem;">0 –≥–æ—Ä–æ–¥–æ–≤, 0 —Ñ–æ—Ç–æ</div>
                </div>
            </div>
        </div>
        <div class="header-right">
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-value" id="cityCount">0</div>
                    <div>–ì–æ—Ä–æ–¥–∞</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="photoCount">0</div>
                    <div>–§–æ—Ç–æ</div>
                </div>
            </div>
            <div class="auth-buttons" id="authButtons">
                <button class="auth-btn" id="loginBtn"><i class="fas fa-sign-in-alt"></i> –í–æ–π—Ç–∏</button>
                <button class="auth-btn primary" id="registerBtn"><i class="fas fa-user-plus"></i> –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
            </div>
            <button class="logout-btn" id="logoutBtn" style="display: none;"><i class="fas fa-sign-out-alt"></i> –í—ã–π—Ç–∏</button>
            <button class="back-to-my-map" id="backToMyMapBtn" style="display: none;"><i class="fas fa-arrow-left"></i> –ö —Å–≤–æ–µ–π –∫–∞—Ä—Ç–µ</button>
        </div>
    </header>
    
    <div class="container">
        <div id="map"></div>
        
        <button class="toggle-sidebar" id="toggleSidebar">‚óÄ</button>
        
        <div class="sidebar" id="sidebar">
            <div class="tab-buttons">
                <button class="tab-btn active" data-tab="cities"><i class="fas fa-city"></i> –ì–æ—Ä–æ–¥–∞</button>
                <button class="tab-btn" data-tab="users"><i class="fas fa-users"></i> –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
            </div>
            
            <div class="tab-content active" id="cities-tab">
                <div id="viewOnlyMessage" class="view-only-message" style="display: none;">
                    <i class="fas fa-eye"></i> –í—ã –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
                    <button class="view-only-back-btn" style="background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: white; padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85rem;"><i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥</button>
                </div>
                
                <div class="city-info">
                    <h2>–í—ã–±—Ä–∞–Ω–Ω—ã–π –≥–æ—Ä–æ–¥</h2>
                    <div class="selected-city">
                        <span id="selectedCity">–ù–µ –≤—ã–±—Ä–∞–Ω</span>
                        <button class="delete-city-btn" id="deleteCityBtn" style="display: none;">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                    <div class="country-name" id="countryName">–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ –∏–∑ —Å–ø–∏—Å–∫–∞</div>
                    <div class="coords-display">
                        <div class="coord-item">
                            <div>–®–∏—Ä–æ—Ç–∞</div>
                            <div class="coord-value" id="latValue">0.0000</div>
                        </div>
                        <div class="coord-item">
                            <div>–î–æ–ª–≥–æ—Ç–∞</div>
                            <div class="coord-value" id="lngValue">0.0000</div>
                        </div>
                    </div>
                </div>
                
                <div id="addCityForm" class="add-city-form">
                    <h2>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –≥–æ—Ä–æ–¥</h2>
                    <div class="form-group">
                        <label for="cityName"><i class="fas fa-map-marker-alt"></i> –ù–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞:</label>
                        <input type="text" id="cityName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°—Ç–∞–º–±—É–ª">
                    </div>
                    
                    <div class="form-group">
                        <label for="countryNameInput"><i class="fas fa-globe"></i> –°—Ç—Ä–∞–Ω–∞:</label>
                        <input type="text" id="countryNameInput" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –¢—É—Ä—Ü–∏—è">
                    </div>
                    
                    <div id="cityLoading" class="loading" style="display: none;">
                        <span class="spinner"></span> –ò—â–µ–º –≥–æ—Ä–æ–¥...
                    </div>
                    
                    <button class="btn" id="addCityBtn"><i class="fas fa-search"></i> –ù–∞–π—Ç–∏ –∏ –¥–æ–±–∞–≤–∏—Ç—å –Ω–∞ –∫–∞—Ä—Ç—É</button>
                    <button class="btn btn-secondary" id="clearFormBtn" style="margin-top: 8px;"><i class="fas fa-eraser"></i> –û—á–∏—Å—Ç–∏—Ç—å</button>
                </div>
                
                <div class="photo-form">
                    <h2>–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ –∫ –≥–æ—Ä–æ–¥—É</h2>
                    <div class="form-group">
                        <label for="photoTitle"><i class="fas fa-heading"></i> –ó–∞–≥–æ–ª–æ–≤–æ–∫:</label>
                        <input type="text" id="photoTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–æ—Ç–æ">
                    </div>
                    
                    <div class="form-group">
                        <label for="photoDescription"><i class="fas fa-align-left"></i> –û–ø–∏—Å–∞–Ω–∏–µ:</label>
                        <textarea id="photoDescription" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –∏–ª–∏ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–µ"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-camera"></i> –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è:</label>
                        <div class="upload-btn" id="uploadBtn"><i class="fas fa-cloud-upload-alt"></i> –í—ã–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ</div>
                        <input type="file" id="photoInput" accept="image/*" style="display: none;">
                        <img id="photoPreview" class="photo-preview" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–æ—Ç–æ">
                    </div>
                    
                    <button class="btn" id="addPhotoBtn"><i class="fas fa-plus-circle"></i> –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ –∫ –≥–æ—Ä–æ–¥—É</button>
                </div>
                
                <h3>–í—Å–µ –≥–æ—Ä–æ–¥–∞</h3>
                <div class="city-list" id="cityListContainer">
                    <!-- –°–ø–∏—Å–æ–∫ –≥–æ—Ä–æ–¥–æ–≤ –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
                </div>
                
                <div class="photo-gallery">
                    <h2>–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –≥–æ—Ä–æ–¥–∞</h2>
                    <div id="cityPhotos"></div>
                </div>
            </div>
            
            <div class="tab-content" id="users-tab">
                <h2>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h2>
                <div class="form-group">
                    <input type="text" id="searchUser" placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...">
                </div>
                
                <div class="users-list" id="usersList">
                    <!-- –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
                </div>
                
                <div class="share-link-container" id="shareLinkContainer" style="display: none;">
                    <h3>–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –º–æ–µ–π –∫–∞—Ä—Ç–æ–π</h3>
                    <div class="share-link" id="shareLink"></div>
                    <button class="btn" id="copyLinkBtn"><i class="fas fa-copy"></i> –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
                </div>
            </div>
        </div>
    </div>
    
    <footer>
        <p><i class="fas fa-heart" style="color: #f87171;"></i> –ö–∞—Ä—Ç—ã –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–π - –¥–µ–ª–∏—Ç–µ—Å—å —Å–≤–æ–∏–º–∏ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è–º–∏</p>
    </footer>

    <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
    <div class="modal-overlay" id="loginModal" style="display: none;">
        <div class="modal">
            <button class="close-modal" id="closeLoginModal"><i class="fas fa-times"></i></button>
            <h3>–í—Ö–æ–¥</h3>
            <div class="form-group">
                <label><i class="fas fa-user"></i> –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
                <input type="text" id="loginUsername" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
            </div>
            <div class="form-group">
                <label><i class="fas fa-lock"></i> –ü–∞—Ä–æ–ª—å:</label>
                <input type="password" id="loginPassword" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
            </div>
            <button class="btn" id="submitLogin"><i class="fas fa-sign-in-alt"></i> –í–æ–π—Ç–∏</button>
            <div class="modal-footer">
                –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a id="switchToRegister">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="registerModal" style="display: none;">
        <div class="modal">
            <button class="close-modal" id="closeRegisterModal"><i class="fas fa-times"></i></button>
            <h3>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
            <div class="form-group">
                <label><i class="fas fa-user"></i> –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
                <input type="text" id="registerUsername" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
            </div>
            <div class="form-group">
                <label><i class="fas fa-lock"></i> –ü–∞—Ä–æ–ª—å:</label>
                <input type="password" id="registerPassword" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å">
            </div>
            <div class="form-group">
                <label><i class="fas fa-lock"></i> –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å:</label>
                <input type="password" id="registerConfirmPassword" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
            </div>
            <button class="btn" id="submitRegister"><i class="fas fa-user-plus"></i> –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
            <div class="modal-footer">
                –£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a id="switchToLogin">–í–æ–π—Ç–∏</a>
            </div>
        </div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
        const map = L.map('map', {
            center: [30, 0],
            zoom: 2,
            minZoom: 1,
            maxZoom: 10,
            worldCopyJump: true,
            crs: L.CRS.EPSG3857
        }).setView([30, 0], 2);
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–ª–æ—è –∫–∞—Ä—Ç—ã —Å –ø–æ–¥–ø–∏—Å—è–º–∏ —Å—Ç—Ä–∞–Ω –∏ –≥–æ—Ä–æ–¥–æ–≤
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', {
            attribution: '',
            maxZoom: 10
        }).addTo(map);
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª–æ–π —Å –ø–æ–¥–ø–∏—Å—è–º–∏ —Å—Ç—Ä–∞–Ω –∏ –≥–æ—Ä–æ–¥–æ–≤ (–ø–æ—è–≤–ª—è—é—Ç—Å—è –ø—Ä–∏ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–∏)
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_only_labels/{z}/{x}/{y}{r}.png', {
            attribution: '',
            maxZoom: 10
        }).addTo(map);
        
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∞—Ç—Ä–∏–±—É—Ü–∏–∏
        map.attributionControl.setPrefix(false);
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let selectedCity = null;
        let allMarkers = [];
        let tempMarker = null;
        let photoMarkers = [];
        let currentCoords = { lat: 0, lng: 0 };
        let currentViewUser = null; // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, —á—å—é –∫–∞—Ä—Ç—É —Å–º–æ—Ç—Ä–∏–º
        
        // –°–∏—Å—Ç–µ–º–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        let currentUser = null;
        let allUsers = JSON.parse(localStorage.getItem('memoryMapsUsers')) || {};
        let allMaps = JSON.parse(localStorage.getItem('memoryMapsData')) || {};
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö, –µ—Å–ª–∏ –Ω–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        if (Object.keys(allUsers).length === 0) {
            allUsers = {
                'demo': {
                    username: 'demo',
                    password: 'demo123',
                    cities: [
                        { name: "–°—Ç–∞–º–±—É–ª", country: "–¢—É—Ä—Ü–∏—è", lat: 41.0082, lng: 28.9784 },
                        { name: "–ú–æ—Å–∫–≤–∞", country: "–†–æ—Å—Å–∏—è", lat: 55.7558, lng: 37.6173 },
                        { name: "–ü–∞—Ä–∏–∂", country: "–§—Ä–∞–Ω—Ü–∏—è", lat: 48.8566, lng: 2.3522 },
                        { name: "–ù—å—é-–ô–æ—Ä–∫", country: "–°–®–ê", lat: 40.7128, lng: -74.0060 },
                        { name: "–¢–æ–∫–∏–æ", country: "–Ø–ø–æ–Ω–∏—è", lat: 35.6762, lng: 139.6503 }
                    ],
                    photos: {
                        '–°—Ç–∞–º–±—É–ª': [
                            {
                                title: "–°–æ–±–æ—Ä –°–≤—è—Ç–æ–π –°–æ—Ñ–∏–∏",
                                description: "–í–µ–ª–∏–∫–æ–ª–µ–ø–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞",
                                image: "https://images.unsplash.com/photo-1524231757912-21f4a3a40316?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80",
                                date: new Date().toLocaleDateString('ru-RU')
                            },
                            {
                                title: "–ì–æ–ª—É–±–∞—è –º–µ—á–µ—Ç—å",
                                description: "–í–µ—á–µ—Ä–Ω–∏–π –°—Ç–∞–º–±—É–ª",
                                image: "https://images.unsplash.com/photo-1541432901042-2d8bd64b4a9b?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80",
                                date: new Date().toLocaleDateString('ru-RU')
                            }
                        ],
                        '–ú–æ—Å–∫–≤–∞': [
                            {
                                title: "–ö—Ä–∞—Å–Ω–∞—è –ø–ª–æ—â–∞–¥—å",
                                description: "–°–µ—Ä–¥—Ü–µ –ú–æ—Å–∫–≤—ã",
                                image: "https://images.unsplash.com/photo-1513326738677-b964603b136d?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80",
                                date: new Date().toLocaleDateString('ru-RU')
                            }
                        ],
                        '–ü–∞—Ä–∏–∂': [
                            {
                                title: "–≠–π—Ñ–µ–ª–µ–≤–∞ –±–∞—à–Ω—è",
                                description: "–°–∏–º–≤–æ–ª –ü–∞—Ä–∏–∂–∞",
                                image: "https://images.unsplash.com/photo-1511739001486-6bfe10ce785f?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80",
                                date: new Date().toLocaleDateString('ru-RU')
                            }
                        ]
                    }
                }
            };
            allMaps = {
                'demo': {
                    cities: allUsers['demo'].cities,
                    photos: allUsers['demo'].photos
                }
            };
            saveAllData();
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
        function saveAllData() {
            localStorage.setItem('memoryMapsUsers', JSON.stringify(allUsers));
            localStorage.setItem('memoryMapsData', JSON.stringify(allMaps));
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function updateStats() {
            if (!currentUser) {
                // –ï—Å–ª–∏ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ–º–æ–π –∫–∞—Ä—Ç—ã
                if (currentViewUser && allMaps[currentViewUser]) {
                    const mapData = allMaps[currentViewUser];
                    const cityCount = mapData.cities ? mapData.cities.length : 0;
                    let photoCount = 0;
                    
                    if (mapData.photos) {
                        Object.values(mapData.photos).forEach(cityPhotos => {
                            photoCount += cityPhotos.length;
                        });
                    }
                    
                    document.getElementById('cityCount').textContent = cityCount;
                    document.getElementById('photoCount').textContent = photoCount;
                }
                return;
            }
            
            const userData = allUsers[currentUser];
            const cityCount = userData.cities ? userData.cities.length : 0;
            let photoCount = 0;
            
            if (userData.photos) {
                Object.values(userData.photos).forEach(cityPhotos => {
                    photoCount += cityPhotos.length;
                });
            }
            
            document.getElementById('cityCount').textContent = cityCount;
            document.getElementById('photoCount').textContent = photoCount;
            document.getElementById('userStats').textContent = `${cityCount} –≥–æ—Ä–æ–¥–æ–≤, ${photoCount} —Ñ–æ—Ç–æ`;
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function updateCurrentUserData() {
            if (!currentUser) return;
            
            const userData = allUsers[currentUser];
            allMaps[currentUser] = {
                cities: userData.cities,
                photos: userData.photos
            };
            saveAllData();
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∏—Å–∫–∞ –≥–æ—Ä–æ–¥–∞ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
        async function searchCityByName(cityName, countryName) {
            try {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                const cityLoading = document.getElementById('cityLoading');
                cityLoading.style.display = 'flex';
                cityLoading.innerHTML = '<span class="spinner"></span> –ò—â–µ–º –≥–æ—Ä–æ–¥...';
                
                // –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å
                const query = `${cityName}, ${countryName}`;
                const encodedQuery = encodeURIComponent(query);
                
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodedQuery}&limit=1&accept-language=ru`
                );
                
                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –≥–æ—Ä–æ–¥–∞');
                }
                
                const data = await response.json();
                
                // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                cityLoading.style.display = 'none';
                
                if (data && data.length > 0) {
                    const result = data[0];
                    return {
                        lat: parseFloat(result.lat),
                        lng: parseFloat(result.lon),
                        displayName: result.display_name,
                        found: true
                    };
                } else {
                    cityLoading.innerHTML = '<span style="color:#f87171">‚ö†Ô∏è –ì–æ—Ä–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω</span>';
                    setTimeout(() => {
                        cityLoading.style.display = 'none';
                    }, 2000);
                    
                    return {
                        lat: null,
                        lng: null,
                        displayName: null,
                        found: false
                    };
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –≥–æ—Ä–æ–¥–∞:', error);
                
                // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                const cityLoading = document.getElementById('cityLoading');
                cityLoading.innerHTML = '<span style="color:#f87171">‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞</span>';
                setTimeout(() => {
                    cityLoading.style.display = 'none';
                }, 2000);
                
                return {
                    lat: null,
                    lng: null,
                    displayName: null,
                    found: false
                };
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –º–∞—Ä–∫–µ—Ä–∞ –≥–æ—Ä–æ–¥–∞
        function createCityMarker(city, isTemp = false) {
            const marker = L.marker([city.lat, city.lng], {
                icon: L.divIcon({
                    className: isTemp ? 'temp-marker' : 'city-marker-icon',
                    html: isTemp ? 'üìç' : '<i class="fas fa-map-marker-alt" style="font-size: 8px;"></i>',
                    iconSize: isTemp ? [26, 26] : [22, 22],
                    iconAnchor: isTemp ? [13, 13] : [11, 11]
                })
            }).addTo(map);
            
            if (!isTemp) {
                marker.cityData = city;
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –æ—Ç–∫—É–¥–∞ –±—Ä–∞—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏
                let photoCount = 0;
                if (currentViewUser && allMaps[currentViewUser] && allMaps[currentViewUser].photos && allMaps[currentViewUser].photos[city.name]) {
                    photoCount = allMaps[currentViewUser].photos[city.name].length;
                } else if (currentUser && allUsers[currentUser] && allUsers[currentUser].photos && allUsers[currentUser].photos[city.name]) {
                    photoCount = allUsers[currentUser].photos[city.name].length;
                }
                
                // –í—Å–ø–ª—ã–≤–∞—é—â–µ–µ –æ–∫–Ω–æ
                marker.bindPopup(`
                    <div style="padding: 10px; min-width: 180px; max-width: 250px;">
                        <strong style="color: #3b82f6; font-size: 14px;">${city.name}</strong><br>
                        <span style="color: #94a3b8; font-size: 12px;">${city.country}</span><br>
                        <div style="margin-top: 8px; font-size: 11px; color: #64748b;">
                            <div>–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π: ${photoCount}</div>
                            <div>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${city.lat.toFixed(4)}, ${city.lng.toFixed(4)}</div>
                        </div>
                        <div style="margin-top: 10px;">
                            <button onclick="window.selectCityFromMap(${JSON.stringify(city).replace(/"/g, '&quot;')})" 
                                    style="background: #3b82f6; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                –í—ã–±—Ä–∞—Ç—å
                            </button>
                        </div>
                    </div>
                `);
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –º–∞—Ä–∫–µ—Ä—É
                marker.on('click', function() {
                    selectCity(city);
                    map.setView([city.lat, city.lng], 6);
                });
            }
            
            return marker;
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –º–∞—Ä–∫–µ—Ä–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ —Å –º–∏–Ω–∏-–∫–∞—Ä—Ç–∏–Ω–∫–æ–π
        function createPhotoMarker(city, photo, photoIndex) {
            // –°–º–µ—â–∞–µ–º –º–∞—Ä–∫–µ—Ä —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –º–∞—Ä–∫–µ—Ä–∞ –≥–æ—Ä–æ–¥–∞
            const offset = 0.0015; // –°–º–µ—â–µ–Ω–∏–µ –≤ –≥—Ä–∞–¥—É—Å–∞—Ö
            const latOffset = (photoIndex % 3) * offset - offset;
            const lngOffset = Math.floor(photoIndex / 3) * offset - offset;
            
            // –°–æ–∑–¥–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–π HTML –¥–ª—è –º–∏–Ω–∏-–∫–∞—Ä—Ç–∏–Ω–∫–∏
            const photoHtml = `
                <div style="width: 30px; height: 30px; border-radius: 50%; border: 2px solid white; overflow: hidden; box-shadow: 0 0 15px rgba(245, 158, 11, 0.7);">
                    <img src="${photo.image}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.src='https://images.unsplash.com/photo-1513326738677-b964603b136d?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80'">
                </div>
            `;
            
            const marker = L.marker([city.lat + latOffset, city.lng + lngOffset], {
                icon: L.divIcon({
                    className: 'mini-photo-marker',
                    html: photoHtml,
                    iconSize: [34, 34],
                    iconAnchor: [17, 17]
                })
            }).addTo(map);
            
            marker.photoData = photo;
            marker.cityData = city;
            
            // –í—Å–ø–ª—ã–≤–∞—é—â–µ–µ –æ–∫–Ω–æ –¥–ª—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏
            marker.bindPopup(`
                <div style="padding: 10px; min-width: 200px; max-width: 300px;">
                    <div style="font-weight: bold; color: #3b82f6; font-size: 14px; margin-bottom: 5px;">${photo.title}</div>
                    <img src="${photo.image}" style="width: 100%; max-height: 150px; object-fit: cover; border-radius: 4px; margin-bottom: 8px; border: 1px solid #e2e8f0;" 
                         onerror="this.src='https://images.unsplash.com/photo-1513326738677-b964603b136d?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80'">
                    <div style="color: #64748b; font-size: 12px; line-height: 1.4; margin-bottom: 5px;">${photo.description}</div>
                    <div style="color: #94a3b8; font-size: 11px;">${photo.date}</div>
                    <div style="margin-top: 8px; font-size: 10px; color: #3b82f6;">${city.name}, ${city.country}</div>
                </div>
            `);
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –º–∞—Ä–∫–µ—Ä—É —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏
            marker.on('click', function() {
                selectCity(city);
                map.setView([city.lat + latOffset, city.lng + lngOffset], 8);
            });
            
            return marker;
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –º–∞—Ä–∫–µ—Ä–æ–≤ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ–º–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function loadAllMarkers() {
            // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –º–∞—Ä–∫–µ—Ä—ã
            allMarkers.forEach(marker => map.removeLayer(marker));
            photoMarkers.forEach(marker => map.removeLayer(marker));
            allMarkers = [];
            photoMarkers = [];
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –æ—Ç–∫—É–¥–∞ –±—Ä–∞—Ç—å –¥–∞–Ω–Ω—ã–µ
            let cities = [];
            let photos = {};
            
            if (currentViewUser && allMaps[currentViewUser]) {
                // –°–º–æ—Ç—Ä–∏–º —á—É–∂—É—é –∫–∞—Ä—Ç—É
                cities = allMaps[currentViewUser].cities || [];
                photos = allMaps[currentViewUser].photos || {};
            } else if (currentUser && allUsers[currentUser]) {
                // –°–≤–æ—è –∫–∞—Ä—Ç–∞
                cities = allUsers[currentUser].cities || [];
                photos = allUsers[currentUser].photos || {};
            } else {
                // –ù–∏—á–µ–≥–æ –Ω–µ—Ç
                updateStats();
                return;
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –≥–æ—Ä–æ–¥–∞
            cities.forEach(city => {
                const marker = createCityMarker(city);
                allMarkers.push(marker);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä—ã –¥–ª—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π —ç—Ç–æ–≥–æ –≥–æ—Ä–æ–¥–∞
                if (photos && photos[city.name]) {
                    photos[city.name].forEach((photo, index) => {
                        const photoMarker = createPhotoMarker(city, photo, index);
                        photoMarkers.push(photoMarker);
                    });
                }
            });
            
            updateStats();
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function loadUserMap(username) {
            currentViewUser = username;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –≤–æ–∑–≤—Ä–∞—Ç–∞
            document.getElementById('backToMyMapBtn').style.display = 'flex';
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –≤—ã—Ö–æ–¥–∞ (–µ—Å–ª–∏ –±—ã–ª–∞ –ø–æ–∫–∞–∑–∞–Ω–∞)
            document.getElementById('logoutBtn').style.display = 'none';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            document.getElementById('selectedCity').textContent = '–ù–µ –≤—ã–±—Ä–∞–Ω';
            document.getElementById('countryName').textContent = `–ö–∞—Ä—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${username}`;
            document.getElementById('cityPhotos').innerHTML = '<div class="empty-gallery">–ü—Ä–æ—Å–º–æ—Ç—Ä –∫–∞—Ä—Ç—ã –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>';
            document.getElementById('deleteCityBtn').style.display = 'none';
            
            // –û—Ç–∫–ª—é—á–∞–µ–º —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            document.getElementById('addCityBtn').disabled = true;
            document.getElementById('addCityBtn').textContent = '–¢–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä';
            document.getElementById('addPhotoBtn').disabled = true;
            document.getElementById('addPhotoBtn').textContent = '–¢–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä';
            document.getElementById('clearFormBtn').disabled = true;
            document.getElementById('uploadBtn').style.opacity = '0.5';
            document.getElementById('uploadBtn').style.pointerEvents = 'none';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
            document.getElementById('viewOnlyMessage').style.display = 'flex';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
            document.querySelector('h1').innerHTML = `üåç –ö–∞—Ä—Ç–∞ ${username}`;
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            loadAllMarkers();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –≥–æ—Ä–æ–¥–æ–≤ (–¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞)
            updateCityListViewOnly(username);
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –≥–æ—Ä–æ–¥–æ–≤ –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
        function updateCityListViewOnly(username) {
            const cityListContainer = document.getElementById('cityListContainer');
            cityListContainer.innerHTML = '';
            
            if (!allMaps[username] || !allMaps[username].cities || allMaps[username].cities.length === 0) {
                cityListContainer.innerHTML = '<div class="empty-gallery">–ù–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –≥–æ—Ä–æ–¥–æ–≤</div>';
                return;
            }
            
            allMaps[username].cities.forEach((city, index) => {
                const photoCount = allMaps[username].photos && allMaps[username].photos[city.name] ? allMaps[username].photos[city.name].length : 0;
                const cityElement = document.createElement('div');
                cityElement.className = `city-item ${selectedCity && selectedCity.name === city.name ? 'active' : ''}`;
                cityElement.innerHTML = `
                    <div>
                        <div class="city-name">${city.name} <span style="color: #f59e0b; font-size: 0.7rem;">(${photoCount})</span></div>
                        <div class="city-coords">${city.country}</div>
                    </div>
                    <div class="city-actions">
                        <button class="city-action-btn" onclick="selectCity(${JSON.stringify(city)})"><i class="fas fa-eye"></i></button>
                    </div>
                `;
                
                cityElement.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('city-action-btn') && !e.target.classList.contains('fa')) {
                        selectCity(city);
                        map.setView([city.lat, city.lng], 6);
                    }
                });
                
                cityListContainer.appendChild(cityElement);
            });
        }
        
        // –í—ã–±–æ—Ä –≥–æ—Ä–æ–¥–∞
        function selectCity(city) {
            selectedCity = city;
            document.getElementById('selectedCity').textContent = city.name;
            document.getElementById('countryName').textContent = city.country;
            document.getElementById('latValue').textContent = city.lat.toFixed(4);
            document.getElementById('lngValue').textContent = city.lng.toFixed(4);
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –æ—Ç–∫—É–¥–∞ –±—Ä–∞—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏
            let photos = {};
            if (currentViewUser && allMaps[currentViewUser]) {
                photos = allMaps[currentViewUser].photos || {};
            } else if (currentUser && allUsers[currentUser]) {
                photos = allUsers[currentUser].photos || {};
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≥–æ—Ä–æ–¥–∞
            loadCityPhotos(city.name, photos);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –≥–æ—Ä–æ–¥–æ–≤
            if (currentViewUser) {
                updateCityListViewOnly(currentViewUser);
            } else {
                updateCityList();
            }
        }
        
        // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–∑–æ–≤–∞ –∏–∑ –ø–æ–ø–∞–ø–∞
        window.selectCityFromMap = selectCity;
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –≥–æ—Ä–æ–¥–∞ –≤ –≥–∞–ª–µ—Ä–µ—é
        function loadCityPhotos(cityName, photos) {
            const cityPhotosElement = document.getElementById('cityPhotos');
            cityPhotosElement.innerHTML = '';
            
            if (!photos || !photos[cityName]) {
                cityPhotosElement.innerHTML = '<div class="empty-gallery">–ù–µ—Ç —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –¥–ª—è —ç—Ç–æ–≥–æ –≥–æ—Ä–æ–¥–∞</div>';
                return;
            }
            
            photos[cityName].forEach((photo, index) => {
                const photoElement = document.createElement('div');
                photoElement.className = 'photo-item';
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–≤–æ–∏—Ö —Ñ–æ—Ç–æ
                const deleteButton = (!currentViewUser && currentUser) ? 
                    `<button class="delete-photo-btn" onclick="deletePhoto('${cityName}', ${index})"><i class="fas fa-times"></i></button>` : '';
                
                photoElement.innerHTML = `
                    ${deleteButton}
                    <img src="${photo.image}" alt="${photo.title}" onerror="this.src='https://images.unsplash.com/photo-1513326738677-b964603b136d?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80'">
                    <div class="photo-caption">${photo.title}</div>
                    <div class="photo-description">${photo.description}</div>
                    <span class="photo-date">${photo.date}</span>
                `;
                cityPhotosElement.appendChild(photoElement);
            });
        }
        
        // –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏
        window.deletePhoto = function(cityName, index) {
            if (!currentUser || currentViewUser) return;
            
            if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é?')) {
                allUsers[currentUser].photos[cityName].splice(index, 1);
                
                // –ï—Å–ª–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å, —É–¥–∞–ª—è–µ–º –≥–æ—Ä–æ–¥ –∏–∑ photosData
                if (allUsers[currentUser].photos[cityName].length === 0) {
                    delete allUsers[currentUser].photos[cityName];
                }
                
                updateCurrentUserData();
                loadCityPhotos(cityName, allUsers[currentUser].photos);
                loadAllMarkers();
            }
        };
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –≥–æ—Ä–æ–¥–æ–≤ –≤ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ (–¥–ª—è —Å–≤–æ–µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞)
        function updateCityList() {
            const cityListContainer = document.getElementById('cityListContainer');
            cityListContainer.innerHTML = '';
            
            if (!currentUser || !allUsers[currentUser] || !allUsers[currentUser].cities || allUsers[currentUser].cities.length === 0) {
                cityListContainer.innerHTML = '<div class="empty-gallery">–ù–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –≥–æ—Ä–æ–¥–æ–≤</div>';
                return;
            }
            
            allUsers[currentUser].cities.forEach((city, index) => {
                const photoCount = allUsers[currentUser].photos && allUsers[currentUser].photos[city.name] ? allUsers[currentUser].photos[city.name].length : 0;
                const cityElement = document.createElement('div');
                cityElement.className = `city-item ${selectedCity && selectedCity.name === city.name ? 'active' : ''}`;
                cityElement.innerHTML = `
                    <div>
                        <div class="city-name">${city.name} <span style="color: #f59e0b; font-size: 0.7rem;">(${photoCount})</span></div>
                        <div class="city-coords">${city.country}</div>
                    </div>
                    <div class="city-actions">
                        <button class="city-action-btn" onclick="selectCity(${JSON.stringify(city)})"><i class="fas fa-eye"></i></button>
                        <button class="city-action-btn delete" onclick="deleteCity(${index})"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                
                cityElement.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('city-action-btn') && !e.target.classList.contains('fa')) {
                        selectCity(city);
                        map.setView([city.lat, city.lng], 6);
                    }
                });
                
                cityListContainer.appendChild(cityElement);
            });
        }
        
        // –£–¥–∞–ª–µ–Ω–∏–µ –≥–æ—Ä–æ–¥–∞
        window.deleteCity = function(index) {
            if (!currentUser || currentViewUser) return;
            
            const cityToDelete = allUsers[currentUser].cities[index];
            
            if (confirm(`–£–¥–∞–ª–∏—Ç—å –≥–æ—Ä–æ–¥ "${cityToDelete.name}" –∏ –≤—Å–µ –µ–≥–æ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏?`)) {
                // –£–¥–∞–ª—è–µ–º –≥–æ—Ä–æ–¥ –∏–∑ –º–∞—Å—Å–∏–≤–∞
                allUsers[currentUser].cities.splice(index, 1);
                
                // –£–¥–∞–ª—è–µ–º —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –≥–æ—Ä–æ–¥–∞
                if (allUsers[currentUser].photos) {
                    delete allUsers[currentUser].photos[cityToDelete.name];
                }
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
                updateCurrentUserData();
                
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ä—Ç—É –∏ —Å–ø–∏—Å–æ–∫
                loadAllMarkers();
                updateCityList();
                
                // –ï—Å–ª–∏ —É–¥–∞–ª–∏–ª–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –≥–æ—Ä–æ–¥, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä
                if (selectedCity && selectedCity.name === cityToDelete.name) {
                    selectedCity = null;
                    document.getElementById('selectedCity').textContent = '–ù–µ –≤—ã–±—Ä–∞–Ω';
                    document.getElementById('countryName').textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ –∏–∑ —Å–ø–∏—Å–∫–∞';
                    document.getElementById('deleteCityBtn').style.display = 'none';
                    document.getElementById('cityPhotos').innerHTML = '<div class="empty-gallery">–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π</div>';
                }
                
                alert(`–ì–æ—Ä–æ–¥ "${cityToDelete.name}" —É–¥–∞–ª–µ–Ω`);
            }
        };
        
        // –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        window.deleteUser = function(username) {
            if (username === currentUser) {
                alert('–í—ã –Ω–µ –º–æ–∂–µ—Ç–µ —É–¥–∞–ª–∏—Ç—å —Å–µ–±—è!');
                return;
            }
            
            if (username === 'demo') {
                alert('–î–µ–º–æ-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å');
                return;
            }
            
            if (confirm(`–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${username}" –∏ –≤—Å–µ –µ–≥–æ –≥–æ—Ä–æ–¥–∞ –∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏?`)) {
                // –£–¥–∞–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                delete allUsers[username];
                delete allMaps[username];
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
                saveAllData();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                updateUsersList();
                
                alert(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "${username}" —É–¥–∞–ª–µ–Ω`);
            }
        };
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function updateUsersList() {
            const usersList = document.getElementById('usersList');
            usersList.innerHTML = '';
            
            Object.keys(allUsers).forEach(username => {
                const userData = allUsers[username];
                const cityCount = userData.cities ? userData.cities.length : 0;
                let photoCount = 0;
                
                if (userData.photos) {
                    Object.values(userData.photos).forEach(cityPhotos => {
                        photoCount += cityPhotos.length;
                    });
                }
                
                const userElement = document.createElement('div');
                userElement.className = `user-item ${username === currentUser ? 'active' : ''}`;
                userElement.innerHTML = `
                    <div class="user-avatar-small">${username.charAt(0).toUpperCase()}</div>
                    <div class="user-details">
                        <div class="user-name">${username}</div>
                        <div class="user-stats">${cityCount} –≥–æ—Ä–æ–¥–æ–≤, ${photoCount} —Ñ–æ—Ç–æ</div>
                    </div>
                    <div class="user-actions">
                        ${username === currentUser ? 
                            '<button class="share-btn" onclick="generateShareLink()"><i class="fas fa-share-alt"></i></button>' : 
                            '<button class="btn-secondary" style="padding: 4px 8px; font-size: 0.8rem;" onclick="viewUserMap(\'' + username + '\')"><i class="fas fa-eye"></i></button>'
                        }
                        ${username !== currentUser && username !== 'demo' ? 
                            '<button class="delete-user-btn" onclick="deleteUser(\'' + username + '\')"><i class="fas fa-trash"></i></button>' : ''
                        }
                    </div>
                `;
                
                usersList.appendChild(userElement);
            });
        }
        
        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Å—ã–ª–∫–∏ –¥–ª—è –æ–±—â–µ–≥–æ –¥–æ—Å—Ç—É–ø–∞
        window.generateShareLink = function() {
            if (!currentUser) return;
            
            const shareLink = `${window.location.origin}${window.location.pathname}?user=${currentUser}`;
            document.getElementById('shareLink').textContent = shareLink;
            document.getElementById('shareLinkContainer').style.display = 'block';
        };
        
        // –ü—Ä–æ—Å–º–æ—Ç—Ä –∫–∞—Ä—Ç—ã –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        window.viewUserMap = function(username) {
            if (!allUsers[username]) {
                alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }
            
            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –≤–∫–ª–∞–¥–∫—É "–ì–æ—Ä–æ–¥–∞"
            document.querySelector('[data-tab="cities"]').click();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ä—Ç—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            loadUserMap(username);
        };
        
        // –í–æ–∑–≤—Ä–∞—Ç –∫ —Å–≤–æ–µ–π –∫–∞—Ä—Ç–µ
        function loadMyMap() {
            if (!currentUser) {
                // –ï—Å–ª–∏ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ä—Ç—É demo
                loadUserMap('demo');
                return;
            }
            
            currentViewUser = null;
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –≤–æ–∑–≤—Ä–∞—Ç–∞
            document.getElementById('backToMyMapBtn').style.display = 'none';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –≤—ã—Ö–æ–¥–∞
            document.getElementById('logoutBtn').style.display = 'flex';
            
            // –í–∫–ª—é—á–∞–µ–º —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            document.getElementById('addCityBtn').disabled = false;
            document.getElementById('addCityBtn').textContent = '–ù–∞–π—Ç–∏ –∏ –¥–æ–±–∞–≤–∏—Ç—å –Ω–∞ –∫–∞—Ä—Ç—É';
            document.getElementById('addPhotoBtn').disabled = false;
            document.getElementById('addPhotoBtn').textContent = '–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ –∫ –≥–æ—Ä–æ–¥—É';
            document.getElementById('clearFormBtn').disabled = false;
            document.getElementById('uploadBtn').style.opacity = '1';
            document.getElementById('uploadBtn').style.pointerEvents = 'auto';
            
            // –°–∫—Ä—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
            document.getElementById('viewOnlyMessage').style.display = 'none';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
            document.querySelector('h1').innerHTML = 'üåç –ú–æ—è –∫–∞—Ä—Ç–∞ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–π';
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ
            loadAllMarkers();
            updateCityList();
            updateStats();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            if (allUsers[currentUser] && allUsers[currentUser].cities && allUsers[currentUser].cities.length > 0) {
                selectCity(allUsers[currentUser].cities[0]);
            } else {
                document.getElementById('selectedCity').textContent = '–ù–µ –≤—ã–±—Ä–∞–Ω';
                document.getElementById('countryName').textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ –∏–∑ —Å–ø–∏—Å–∫–∞';
                document.getElementById('deleteCityBtn').style.display = 'none';
                document.getElementById('cityPhotos').innerHTML = '<div class="empty-gallery">–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π</div>';
            }
        }
        
        // –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
        function logout() {
            currentUser = null;
            currentViewUser = null;
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
            document.getElementById('userInfo').style.display = 'none';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –≤—Ö–æ–¥–∞/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
            document.getElementById('authButtons').style.display = 'flex';
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –≤—ã—Ö–æ–¥–∞
            document.getElementById('logoutBtn').style.display = 'none';
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –≤–æ–∑–≤—Ä–∞—Ç–∞
            document.getElementById('backToMyMapBtn').style.display = 'none';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ä—Ç—É demo
            loadUserMap('demo');
            
            // –û—á–∏—â–∞–µ–º localStorage
            localStorage.removeItem('memoryMapsCurrentUser');
        }
        
        // –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É
        function login(username, password) {
            if (!allUsers[username]) {
                alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return false;
            }
            
            if (allUsers[username].password !== password) {
                alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
                return false;
            }
            
            currentUser = username;
            currentViewUser = null;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            document.getElementById('userInfo').style.display = 'flex';
            document.getElementById('userName').textContent = username;
            document.getElementById('userAvatar').textContent = username.charAt(0).toUpperCase();
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –≤—Ö–æ–¥–∞/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
            document.getElementById('authButtons').style.display = 'none';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –≤—ã—Ö–æ–¥–∞
            document.getElementById('logoutBtn').style.display = 'flex';
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –≤–æ–∑–≤—Ä–∞—Ç–∞ (–º—ã —É–∂–µ –Ω–∞ —Å–≤–æ–µ–π –∫–∞—Ä—Ç–µ)
            document.getElementById('backToMyMapBtn').style.display = 'none';
            
            // –í–∫–ª—é—á–∞–µ–º —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            document.getElementById('addCityBtn').disabled = false;
            document.getElementById('addCityBtn').textContent = '–ù–∞–π—Ç–∏ –∏ –¥–æ–±–∞–≤–∏—Ç—å –Ω–∞ –∫–∞—Ä—Ç—É';
            document.getElementById('addPhotoBtn').disabled = false;
            document.getElementById('addPhotoBtn').textContent = '–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ –∫ –≥–æ—Ä–æ–¥—É';
            document.getElementById('clearFormBtn').disabled = false;
            document.getElementById('uploadBtn').style.opacity = '1';
            document.getElementById('uploadBtn').style.pointerEvents = 'auto';
            
            // –°–∫—Ä—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
            document.getElementById('viewOnlyMessage').style.display = 'none';
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            loadAllMarkers();
            updateCityList();
            updateStats();
            updateUsersList();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
            document.querySelector('h1').innerHTML = 'üåç –ú–æ—è –∫–∞—Ä—Ç–∞ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–π';
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            document.getElementById('loginModal').style.display = 'none';
            
            // –í—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π –≥–æ—Ä–æ–¥, –µ—Å–ª–∏ –µ—Å—Ç—å
            if (allUsers[currentUser] && allUsers[currentUser].cities && allUsers[currentUser].cities.length > 0) {
                selectCity(allUsers[currentUser].cities[0]);
            }
            
            return true;
        }
        
        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
        function register(username, password) {
            if (allUsers[username]) {
                alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
                return false;
            }
            
            if (username.length < 3) {
                alert('–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 3 —Å–∏–º–≤–æ–ª–æ–≤');
                return false;
            }
            
            if (password.length < 4) {
                alert('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 4 —Å–∏–º–≤–æ–ª–æ–≤');
                return false;
            }
            
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            allUsers[username] = {
                username: username,
                password: password,
                cities: [],
                photos: {}
            };
            
            allMaps[username] = {
                cities: [],
                photos: {}
            };
            
            saveAllData();
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—Ö–æ–¥–∏–º
            login(username, password);
            
            return true;
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ URL –¥–ª—è –æ–±—â–µ–≥–æ –¥–æ—Å—Ç—É–ø–∞
        function checkUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const sharedUser = urlParams.get('user');
            
            if (sharedUser && allUsers[sharedUser]) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ä—Ç—É –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                loadUserMap(sharedUser);
                return true;
            }
            
            return false;
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', async function() {
            // –ö–Ω–æ–ø–∫–∏ –≤—Ö–æ–¥–∞/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω—ã –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ
            document.getElementById('authButtons').style.display = 'flex';
            document.getElementById('logoutBtn').style.display = 'none';
            document.getElementById('backToMyMapBtn').style.display = 'none';
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã URL –¥–ª—è –æ–±—â–µ–≥–æ –¥–æ—Å—Ç—É–ø–∞
            const isSharedView = checkUrlParams();
            
            if (!isSharedView) {
                // –ü—ã—Ç–∞–µ–º—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ–π—Ç–∏
                const savedUser = localStorage.getItem('memoryMapsCurrentUser');
                if (savedUser && allUsers[savedUser]) {
                    login(savedUser, allUsers[savedUser].password);
                } else {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ä—Ç—É demo –¥–ª—è –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö
                    loadUserMap('demo');
                }
            }
            
            updateUsersList();
            
            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –≤–∫–ª–∞–¥–∫–∏
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                });
            });
            
            // –ö–Ω–æ–ø–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫ —Å–≤–æ–µ–π –∫–∞—Ä—Ç–µ
            document.getElementById('backToMyMapBtn').addEventListener('click', function() {
                loadMyMap();
            });
            
            // –ö–Ω–æ–ø–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∏–∑ —Ä–µ–∂–∏–º–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
            document.querySelectorAll('.view-only-back-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    loadMyMap();
                });
            });
            
            // –ö–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞
            document.getElementById('logoutBtn').addEventListener('click', function() {
                logout();
            });
            
            // –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≥–æ—Ä–æ–¥–∞
            document.getElementById('addCityBtn').addEventListener('click', async function() {
                if (!currentUser || currentViewUser) {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
                    document.getElementById('loginBtn').click();
                    return;
                }
                
                const cityName = document.getElementById('cityName').value.trim();
                const countryName = document.getElementById('countryNameInput').value.trim();
                
                if (!cityName) {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞');
                    document.getElementById('cityName').focus();
                    return;
                }
                
                if (!countryName) {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω—ã');
                    document.getElementById('countryNameInput').focus();
                    return;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–≥–æ –≥–æ—Ä–æ–¥–∞
                if (allUsers[currentUser].cities.some(city => 
                    city.name.toLowerCase() === cityName.toLowerCase() && 
                    city.country.toLowerCase() === countryName.toLowerCase())) {
                    alert('–≠—Ç–æ—Ç –≥–æ—Ä–æ–¥ —É–∂–µ –µ—Å—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ!');
                    return;
                }
                
                // –ò—â–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≥–æ—Ä–æ–¥–∞
                const location = await searchCityByName(cityName, countryName);
                
                if (!location.found) {
                    alert(`–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –≥–æ—Ä–æ–¥ "${cityName}" –≤ —Å—Ç—Ä–∞–Ω–µ "${countryName}".\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –Ω–∞–ø–∏—Å–∞–Ω–∏—è.`);
                    return;
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
                currentCoords = { lat: location.lat, lng: location.lng };
                
                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –≥–æ—Ä–æ–¥
                const newCity = {
                    name: cityName,
                    country: countryName,
                    lat: location.lat,
                    lng: location.lng
                };
                
                // –î–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –º–∞—Ä–∫–µ—Ä
                if (tempMarker) {
                    map.removeLayer(tempMarker);
                }
                
                tempMarker = createCityMarker(newCity, true);
                tempMarker.bindPopup(`
                    <div style="padding: 10px; min-width: 180px;">
                        <strong>${cityName}</strong><br>
                        <span>${countryName}</span><br>
                        <small>–ù–∞–π–¥–µ–Ω–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</small>
                        <div style="margin-top: 10px;">
                            <button onclick="addCityConfirmed(${JSON.stringify(newCity).replace(/"/g, '&quot;')})" 
                                    style="background: #3b82f6; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                –î–æ–±–∞–≤–∏—Ç—å –Ω–∞ –∫–∞—Ä—Ç—É
                            </button>
                        </div>
                    </div>
                `).openPopup();
                
                // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –∫–∞—Ä—Ç—É –∫ –Ω–∞–π–¥–µ–Ω–Ω–æ–º—É –≥–æ—Ä–æ–¥—É
                map.setView([location.lat, location.lng], 8);
            });
            
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≥–æ—Ä–æ–¥–∞
            window.addCityConfirmed = function(newCity) {
                // –î–æ–±–∞–≤–ª—è–µ–º –≥–æ—Ä–æ–¥ –≤ –º–∞—Å—Å–∏–≤
                allUsers[currentUser].cities.push(newCity);
                
                // –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –º–∞—Ä–∫–µ—Ä
                if (tempMarker) {
                    map.removeLayer(tempMarker);
                    tempMarker = null;
                }
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
                updateCurrentUserData();
                
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ä—Ç—É
                loadAllMarkers();
                
                // –í—ã–±–∏—Ä–∞–µ–º –Ω–æ–≤—ã–π –≥–æ—Ä–æ–¥
                selectCity(newCity);
                map.setView([newCity.lat, newCity.lng], 6);
                
                // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                document.getElementById('cityName').value = '';
                document.getElementById('countryNameInput').value = '';
                
                alert(`–ì–æ—Ä–æ–¥ "${newCity.name}" —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω –Ω–∞ –∫–∞—Ä—Ç—É!`);
            };
            
            // –ö–Ω–æ–ø–∫–∞ –æ—á–∏—Å—Ç–∫–∏ —Ñ–æ—Ä–º—ã
            document.getElementById('clearFormBtn').addEventListener('click', function() {
                document.getElementById('cityName').value = '';
                document.getElementById('countryNameInput').value = '';
                document.getElementById('cityLoading').style.display = 'none';
                
                if (tempMarker) {
                    map.removeLayer(tempMarker);
                    tempMarker = null;
                }
                
                document.getElementById('cityName').focus();
            });
            
            // –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≥–æ—Ä–æ–¥–∞
            document.getElementById('deleteCityBtn').addEventListener('click', function() {
                if (!currentUser || currentViewUser) {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
                    return;
                }
                
                if (!selectedCity) {
                    alert('–ù–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≥–æ—Ä–æ–¥–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è');
                    return;
                }
                
                const index = allUsers[currentUser].cities.findIndex(city => 
                    city.name === selectedCity.name && 
                    city.country === selectedCity.country);
                
                if (index !== -1) {
                    window.deleteCity(index);
                }
            });
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π
            document.getElementById('uploadBtn').addEventListener('click', function() {
                if (!currentUser || currentViewUser) {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
                    return;
                }
                document.getElementById('photoInput').click();
            });
            
            document.getElementById('photoInput').addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        document.getElementById('photoPreview').src = e.target.result;
                        document.getElementById('photoPreview').style.display = 'block';
                    }
                    
                    reader.readAsDataURL(this.files[0]);
                }
            });
            
            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ –∫ –≥–æ—Ä–æ–¥—É
            document.getElementById('addPhotoBtn').addEventListener('click', function() {
                if (!currentUser || currentViewUser) {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
                    document.getElementById('loginBtn').click();
                    return;
                }
                
                if (!selectedCity) {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ –Ω–∞ –∫–∞—Ä—Ç–µ');
                    return;
                }
                
                const title = document.getElementById('photoTitle').value.trim();
                const description = document.getElementById('photoDescription').value.trim();
                const image = document.getElementById('photoPreview').src;
                
                if (!title) {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è —Ñ–æ—Ç–æ');
                    return;
                }
                
                if (image === '') {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é');
                    return;
                }
                
                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç —Ñ–æ—Ç–æ
                const newPhoto = {
                    title,
                    description,
                    image,
                    date: new Date().toLocaleDateString('ru-RU')
                };
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç photos, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
                if (!allUsers[currentUser].photos) {
                    allUsers[currentUser].photos = {};
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ –≤ –º–∞—Å—Å–∏–≤ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≥–æ—Ä–æ–¥–∞
                if (!allUsers[currentUser].photos[selectedCity.name]) {
                    allUsers[currentUser].photos[selectedCity.name] = [];
                }
                
                allUsers[currentUser].photos[selectedCity.name].unshift(newPhoto);
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
                updateCurrentUserData();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –≥–∞–ª–µ—Ä–µ–∏ –∏ –º–∞—Ä–∫–µ—Ä—ã
                loadCityPhotos(selectedCity.name, allUsers[currentUser].photos);
                loadAllMarkers();
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
                document.getElementById('photoTitle').value = '';
                document.getElementById('photoDescription').value = '';
                document.getElementById('photoPreview').src = '';
                document.getElementById('photoPreview').style.display = 'none';
                document.getElementById('photoInput').value = '';
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                alert(`–§–æ—Ç–æ "${title}" —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ –∫ –≥–æ—Ä–æ–¥—É ${selectedCity.name}!`);
                
                // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –∫–∞—Ä—Ç—É –∫ –≥–æ—Ä–æ–¥—É, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –Ω–æ–≤—É—é –∏–∫–æ–Ω–∫—É
                map.setView([selectedCity.lat, selectedCity.lng], 7);
            });
            
            // –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏
            document.getElementById('toggleSidebar').addEventListener('click', function() {
                const sidebar = document.getElementById('sidebar');
                const isCollapsed = sidebar.classList.contains('collapsed');
                
                if (isCollapsed) {
                    sidebar.classList.remove('collapsed');
                    this.textContent = '‚óÄ';
                    this.style.right = '390px';
                } else {
                    sidebar.classList.add('collapsed');
                    this.textContent = '‚ñ∂';
                    this.style.right = '10px';
                }
            });
            
            // –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
            document.getElementById('loginBtn').addEventListener('click', function() {
                document.getElementById('loginModal').style.display = 'flex';
            });
            
            document.getElementById('registerBtn').addEventListener('click', function() {
                document.getElementById('registerModal').style.display = 'flex';
            });
            
            document.getElementById('closeLoginModal').addEventListener('click', function() {
                document.getElementById('loginModal').style.display = 'none';
            });
            
            document.getElementById('closeRegisterModal').addEventListener('click', function() {
                document.getElementById('registerModal').style.display = 'none';
            });
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∏—Ö
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.style.display = 'none';
                    }
                });
            });
            
            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –º–æ–¥–∞–ª—å–Ω—ã–º–∏ –æ–∫–Ω–∞–º–∏
            document.getElementById('switchToRegister').addEventListener('click', function() {
                document.getElementById('loginModal').style.display = 'none';
                document.getElementById('registerModal').style.display = 'flex';
            });
            
            document.getElementById('switchToLogin').addEventListener('click', function() {
                document.getElementById('registerModal').style.display = 'none';
                document.getElementById('loginModal').style.display = 'flex';
            });
            
            // –í—Ö–æ–¥
            document.getElementById('submitLogin').addEventListener('click', function() {
                const username = document.getElementById('loginUsername').value.trim();
                const password = document.getElementById('loginPassword').value.trim();
                
                if (login(username, password)) {
                    localStorage.setItem('memoryMapsCurrentUser', username);
                }
            });
            
            // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
            document.getElementById('submitRegister').addEventListener('click', function() {
                const username = document.getElementById('registerUsername').value.trim();
                const password = document.getElementById('registerPassword').value.trim();
                const confirmPassword = document.getElementById('registerConfirmPassword').value.trim();
                
                if (password !== confirmPassword) {
                    alert('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç');
                    return;
                }
                
                if (register(username, password)) {
                    localStorage.setItem('memoryMapsCurrentUser', username);
                }
            });
            
            // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏
            document.getElementById('copyLinkBtn').addEventListener('click', function() {
                const shareLink = document.getElementById('shareLink').textContent;
                navigator.clipboard.writeText(shareLink).then(() => {
                    alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
                });
            });
            
            // –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            document.getElementById('searchUser').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const userItems = document.querySelectorAll('.user-item');
                
                userItems.forEach(item => {
                    const userName = item.querySelector('.user-name').textContent.toLowerCase();
                    if (userName.includes(searchTerm)) {
                        item.style.display = 'flex';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });
            
            // –ê–≤—Ç–æ–≤—Ö–æ–¥ —Å –∫–ª–∞–≤–∏—à–∏ Enter –≤ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–Ω–∞—Ö
            document.getElementById('loginPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('submitLogin').click();
                }
            });
            
            document.getElementById('registerConfirmPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('submitRegister').click();
                }
            });
        });
    </script>
</body>
</html>
